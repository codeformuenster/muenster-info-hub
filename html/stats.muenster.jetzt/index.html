<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Münster.jetzt Daten-Dashboard</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/19.2.3/css/dx.common.css" />
  <link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/19.2.3/css/dx.light.css" />
  <script src="https://cdn3.devexpress.com/jslib/19.2.3/js/dx.all.js"></script>

</head>

<body>
  <div >
    <div style="float:left" id="pie"></div>
    <div id="pie2"></div>
  </div>

  <script>
   
    $(function(){
      $.getJSON( "https://api.muenster.jetzt/msinfohub-events/_search?_source=source,geo,start_date&size=200&q=start_date:%3Enow", function( data ) {
        var items = {};
        var geos = {};
        $.each( data.hits.hits, function( key, val ) {
          if (val._source.source  in items) {
            items[ val._source.source ] ++;

            if ("geo" in val._source) {
              if  (val._source.source in geos) {
                geos[ val._source.source ] ++;
              } else {
                geos[ val._source.source ] = 0;
              }
            }

          } else {
            items[ val._source.source ] = 0;
          }
        });

        var dataSource = []
        $.each( items, function (key, val) {
          dataSource.push({
            quelle: key,
            anzahl: val
          });
        });
        
        var geoSource = []
        $.each( geos, function (key, val) {
          geoSource.push({
            quelle: key,
            anzahl: val
          });
        });
        
        var chartSettings = {
            size: {
                width: 500
            },
            palette: "bright",
            dataSource: dataSource,
            series: [
                {
                    argumentField: "quelle",
                    valueField: "anzahl",
                    label: {
                        visible: true,
                        connector: {
                            visible: true,
                            width: 1
                        }
                    }
                }
            ],
            title: "Anzahl zukünftiger Veranstaltungen",
            "export": {
                enabled: true
            },
            onPointClick: function (e) {
                var point = e.target;
        
                toggleVisibility(point);
            },
            onLegendClick: function (e) {
                var arg = e.target;
        
                toggleVisibility(this.getAllSeries()[0].getPointsByArg(arg)[0]);
            }
        };

        $("#pie").dxPieChart(chartSettings);

        chartSettings["dataSource"] = geoSource;
        chartSettings["title"] = "Veranstaltungen mit Geokoordinaten"
        $("#pie2").dxPieChart(chartSettings);
        
        function toggleVisibility(item) {
            if(item.isVisible()) {
                item.hide();
            } else { 
                item.show();
            }
        }

      });
    });
  </script>
</body>

</html>
